
-----------------------------------------------------------------------
1. Managing TLS certificates
-----------------------------------------------------------------------

Strimzi supports TLS for encrypted communication between Kafka and Strimzi components.

Strimzi establishes encrypted TLS connections for communication between the following components:

- Kafka brokers and ZooKeeper nodes
- Kafka brokers (interbroker communication)
- ZooKeeper nodes (internodal communication)
- Strimzi operators and Kafka and ZooKeeper
- Cruise Control and Kafka
- Kafka Exporter and Kafka

ðŸ‘‰ Connections between clients and brokers use listeners that you must configure to use TLS-encrypted communication. 

https://strimzi.io/docs/operators/latest/images/secure_communication.png



----------------------------------------------------------------------------------------------------------
1.1 Internal cluster CA and clients CA
----------------------------------------------------------------------------------------------------------


ðŸ‘‰ To support encryption, each Strimzi component needs its own private keys and public key certificates. 
ðŸ‘‰ All component certificates are signed by an internal CA (certificate authority) called the cluster CA.
ðŸ‘‰ CA (Certificate Authority) certificates are generated by the Cluster Operator to verify the identities of components and clients.


ðŸ‘‰ Similarly, each Kafka client application connecting to Strimzi using mTLS needs to use private keys and certificates. 
ðŸ‘‰ A second internal CA, named the clients CA, is used to sign certificates for the Kafka clients.


ðŸ‘‰ Both the cluster CA and clients CA have a self-signed public key certificate.


ðŸ‘‰ Kafka brokers are configured to trust certificates signed by either the cluster CA or clients CA. 
ðŸ‘‰ Components that clients do not need to connect to, such as ZooKeeper, only trust certificates signed by the  cluster CA


ðŸ‘‰ Unless TLS encryption for external listeners is disabled, client applications must trust certificates signed by the cluster CA. 
ðŸ‘‰ This is also true for client applications that perform mTLS authentication.



By default, Strimzi automatically generates and renews CA certificates issued by the cluster CA or clients CA. 
You can configure the management of these CA certificates using Kafka.spec.clusterCa and Kafka.spec.clientsCa properties.


----------------------------------------------------------------------------------------------------------
1.2 Secrets generated by the operators
----------------------------------------------------------------------------------------------------------


ðŸ‘‰ The Cluster Operator automatically sets up and renews TLS certificates to enable encryption and authentication within a cluster.

ðŸ‘‰ It also sets up other TLS certificates if you want to enable encryption or mTLS authentication between Kafka brokers and clients.

ðŸ‘‰ Secrets are created when custom resources are deployed, such as Kafka and KafkaUser

ðŸ‘‰ Strimzi uses these secrets to store private and public key certificates for Kafka clusters, clients, and users.

ðŸ‘‰ The secrets are used for establishing TLS encrypted connections between Kafka brokers, and between brokers and clients. 

ðŸ‘‰ They are also used for mTLS authentication.


ðŸ‘‰ Cluster and clients secrets are always pairs: one contains the public key and one contains the private key.

Cluster secret:
- A cluster secret contains the cluster CA to sign Kafka broker certificates. 
- Connecting clients use the certificate to establish a TLS encrypted connection with a Kafka cluster. 
- The certificate verifies broker identity.


Client secret:
- A client secret contains the clients CA for a user to sign its own client certificate. 
- This allows mutual authentication against the Kafka cluster. 
- The broker validates a clientâ€™s identity through the certificate.

User secret:
- A user secret contains a private key and certificate. 
- The secret is created and signed by the clients CA when a new user is created. 
- The key and certificate are used to authenticate and authorize the user when accessing the cluster.


----------------------------------------------------------------------------------------------------------


TLS authentication using keys and certificates in PEM or PKCS #12 format

- PEM and PKCS #12 are OpenSSL-generated key formats for TLS communications using the SSL protocol.
- With the Kafka cluster and client set up to use mTLS, you extract credentials from the secrets and add them to your client configuration.


For PEM, you add the following to your client configuration:

- Truststore
    - ca.crt from the <cluster_name>-cluster-ca-cert secret, which is the CA certificate for the cluster.

- Keystore
    - user.crt from the <kafka_user_name> secret, which is the public certificate of the user.
    - user.key from the <kafka_user_name> secret, which is the private key of the user.

----------------------------------------------------------------------------------------------------------
Secrets generated by the Cluster Operator
----------------------------------------------------------------------------------------------------------

The Cluster Operator generates the following certificates, which are saved as secrets in the Kubernetes cluster. 
Strimzi uses these secrets by default.


# <cluster_name>-cluster-ca
- Contains the private key of the cluster CA. 
- Strimzi and Kafka components use the private key to sign server certificates.

# <cluster_name>-cluster-ca-cert
- Contains the public key of the cluster CA. 
- Kafka clients use the public key to verify the identity of the Kafka brokers they are connecting to with TLS server authentication.

# <cluster_name>-clients-ca
- Contains the private key of the clients CA. 
- Kafka clients use the private key to sign new user certificates for mTLS authentication when connecting to Kafka brokers.

# <cluster_name>-clients-ca-cert
- Contains the public key of the clients CA. 
- Kafka brokers use the public key to verify the identity of the Kafka clients they are connecting to with mTLS client authentication.


Secrets for communication between Strimzi components contain a private key and a public key certificate signed by the cluster CA.

# <cluster_name>-kafka-brokers
- Contains the private and public keys for Kafka brokers.

# <cluster_name>-zookeeper-nodes
- Contains the private and public keys for ZooKeeper nodes.

# <cluster_name>-cluster-operator-certs
- Contains the private and public keys for encrypting communication between the Cluster Operator and Kafka or ZooKeeper.

# <cluster_name>-entity-topic-operator-certs
- Contains the private and public keys for encrypting communication between the Topic Operator and Kafka or ZooKeeper.

# <cluster_name>-entity-user-operator-certs
- Contains the private and public keys for encrypting communication between the User Operator and Kafka or ZooKeeper.

# <cluster_name>-cruise-control-certs
- Contains the private and public keys for encrypting communication between Cruise Control and Kafka or ZooKeeper.

# <cluster_name>-kafka-exporter-certs
- Contains the private and public keys for encrypting communication between Kafka Exporter and Kafka or ZooKeeper.

----------------------------------------------------------------------------------------------------------

Cluster CA secrets

- Cluster CA secrets are managed by the Cluster Operator in a Kafka cluster.

- Only the <cluster_name>-cluster-ca-cert secret is required by clients. 
- All other cluster secrets are accessed by Strimzi components. 
- You can enforce this using Kubernetes role-based access controls, if necessary.


----------------------------------------------------------------------------------------------------------

Clients CA secrets

- Clients CA secrets are managed by the Cluster Operator in a Kafka cluster.
- The certificates in <cluster_name>-clients-ca-cert are those which the Kafka brokers trust.

- The <cluster_name>-clients-ca secret is used to sign the certificates of client applications. 
- This secret must be accessible to the Strimzi components and for administrative access if you are intending to issue application certificates without using the User Operator. 
- You can enforce this using Kubernetes role-based access controls, if necessary.


----------------------------------------------------------------------------------------------------------
1.3 Certificate renewal and validity periods
----------------------------------------------------------------------------------------------------------


For CA certificates automatically created by the Cluster Operator, you can configure the validity period of:

- Cluster CA certificates in Kafka.spec.clusterCa.validityDays
- Clients CA certificates in Kafka.spec.clientsCa.validityDays

The default validity period for both certificates is 365 days. Manually-installed CA certificates should have their own validity periods defined.


You can configure the renewal period of the certificates created by the Cluster Operator:

- Cluster CA certificates in Kafka.spec.clusterCa.renewalDays
- Clients CA certificates in Kafka.spec.clientsCa.renewalDays

The default renewal period for both certificates is 30 days.


----------------------------------------------------------------------------------------------------------
Configuring internal clients to trust the cluster CA
----------------------------------------------------------------------------------------------------------

https://strimzi.io/docs/operators/latest/deploying#configuring-internal-clients-to-trust-cluster-ca-str


----------------------------------------------------------------------------------------------------------
Configuring external clients to trust the cluster CA
----------------------------------------------------------------------------------------------------------

https://strimzi.io/docs/operators/latest/deploying#configuring-external-clients-to-trust-cluster-ca-str




----------------------------------------------------------------------------------------------------------
Using your own CA certificates and private keys
----------------------------------------------------------------------------------------------------------

https://strimzi.io/docs/operators/latest/deploying#security-using-your-own-certificates-str

https://strimzi.io/docs/operators/latest/deploying#renewing-your-own-ca-certificates-str

https://strimzi.io/docs/operators/latest/deploying#proc-replacing-your-own-private-keys-str


----------------------------------------------------------------------------------------------------------